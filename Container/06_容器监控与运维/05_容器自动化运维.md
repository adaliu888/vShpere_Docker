# 容器自动化运维

## 目录

- [容器自动化运维](#容器自动化运维)
  - [1. 自动化运维概述](#1-自动化运维概述)
    - [1.1 自动化运维目标](#11-自动化运维目标)
    - [1.2 自动化运维架构](#12-自动化运维架构)
  - [2. 容器编排自动化](#2-容器编排自动化)
    - [2.1 Kubernetes自动化](#21-kubernetes自动化)
- [自动部署配置](#自动部署配置)
    - [2.2 服务发现自动化](#22-服务发现自动化)
- [服务自动发现](#服务自动发现)
  - [3. 部署自动化](#3-部署自动化)
    - [3.1 CI/CD流水线](#31-cicd流水线)
- [GitLab CI配置](#gitlab-ci配置)
    - [3.2 蓝绿部署](#32-蓝绿部署)
- [蓝绿部署配置](#蓝绿部署配置)
  - [4. 监控自动化](#4-监控自动化)
    - [4.1 自动告警](#41-自动告警)
- [Prometheus告警规则](#prometheus告警规则)
    - [4.2 自动恢复](#42-自动恢复)
- [自动恢复配置](#自动恢复配置)
  - [5. 故障自愈](#5-故障自愈)
    - [5.1 健康检查](#51-健康检查)
- [健康检查配置](#健康检查配置)
    - [5.2 自动重启](#52-自动重启)
- [自动重启配置](#自动重启配置)
  - [6. 扩缩容自动化](#6-扩缩容自动化)
    - [6.1 水平扩缩容](#61-水平扩缩容)
- [HPA配置](#hpa配置)
    - [6.2 垂直扩缩容](#62-垂直扩缩容)
- [VPA配置](#vpa配置)
  - [7. 备份恢复自动化](#7-备份恢复自动化)
    - [7.1 自动备份](#71-自动备份)
- [备份CronJob](#备份cronjob)
    - [7.2 自动恢复](#72-自动恢复)
- [恢复脚本](#恢复脚本)
  - [8. 安全自动化](#8-安全自动化)
    - [8.1 自动扫描](#81-自动扫描)
- [安全扫描CronJob](#安全扫描cronjob)
    - [8.2 自动更新](#82-自动更新)
- [自动更新配置](#自动更新配置)
  - [9. 实践案例](#9-实践案例)
    - [9.1 微服务自动化运维](#91-微服务自动化运维)
- [微服务自动化配置](#微服务自动化配置)
    - [9.2 数据库自动化运维](#92-数据库自动化运维)
- [数据库自动化配置](#数据库自动化配置)
  - [10. 最佳实践](#10-最佳实践)
    - [10.1 自动化原则](#101-自动化原则)
    - [10.2 实施建议](#102-实施建议)
    - [10.3 注意事项](#103-注意事项)

- [容器自动化运维](#容器自动化运维)
  - [1. 自动化运维概述](#1-自动化运维概述)
    - [1.1 自动化运维目标](#11-自动化运维目标)
    - [1.2 自动化运维架构](#12-自动化运维架构)
  - [2. 容器编排自动化](#2-容器编排自动化)
    - [2.1 Kubernetes自动化](#21-kubernetes自动化)
- [自动部署配置](#自动部署配置)
    - [2.2 服务发现自动化](#22-服务发现自动化)
- [服务自动发现](#服务自动发现)
  - [3. 部署自动化](#3-部署自动化)
    - [3.1 CI/CD流水线](#31-cicd流水线)
- [GitLab CI配置](#gitlab-ci配置)
    - [3.2 蓝绿部署](#32-蓝绿部署)
- [蓝绿部署配置](#蓝绿部署配置)
  - [4. 监控自动化](#4-监控自动化)
    - [4.1 自动告警](#41-自动告警)
- [Prometheus告警规则](#prometheus告警规则)
    - [4.2 自动恢复](#42-自动恢复)
- [自动恢复配置](#自动恢复配置)
  - [5. 故障自愈](#5-故障自愈)
    - [5.1 健康检查](#51-健康检查)
- [健康检查配置](#健康检查配置)
    - [5.2 自动重启](#52-自动重启)
- [自动重启配置](#自动重启配置)
  - [6. 扩缩容自动化](#6-扩缩容自动化)
    - [6.1 水平扩缩容](#61-水平扩缩容)
- [HPA配置](#hpa配置)
    - [6.2 垂直扩缩容](#62-垂直扩缩容)
- [VPA配置](#vpa配置)
  - [7. 备份恢复自动化](#7-备份恢复自动化)
    - [7.1 自动备份](#71-自动备份)
- [备份CronJob](#备份cronjob)
    - [7.2 自动恢复](#72-自动恢复)
- [恢复脚本](#恢复脚本)
  - [8. 安全自动化](#8-安全自动化)
    - [8.1 自动扫描](#81-自动扫描)
- [安全扫描CronJob](#安全扫描cronjob)
- [发送扫描结果到安全团队](#发送扫描结果到安全团队)
    - [8.2 自动更新](#82-自动更新)
- [自动更新配置](#自动更新配置)
- [检查镜像更新](#检查镜像更新)
  - [9. 实践案例](#9-实践案例)
    - [9.1 微服务自动化运维](#91-微服务自动化运维)
- [微服务自动化配置](#微服务自动化配置)
    - [9.2 数据库自动化运维](#92-数据库自动化运维)
- [数据库自动化配置](#数据库自动化配置)
  - [10. 最佳实践](#10-最佳实践)
    - [10.1 自动化原则](#101-自动化原则)
    - [10.2 实施建议](#102-实施建议)
    - [10.3 注意事项](#103-注意事项)

- [容器自动化运维](#容器自动化运维)
  - [1. 自动化运维概述](#1-自动化运维概述)
  - [2. 容器编排自动化](#2-容器编排自动化)
  - [3. 部署自动化](#3-部署自动化)
  - [4. 监控自动化](#4-监控自动化)
  - [5. 故障自愈](#5-故障自愈)
  - [6. 扩缩容自动化](#6-扩缩容自动化)
  - [7. 备份恢复自动化](#7-备份恢复自动化)
  - [8. 安全自动化](#8-安全自动化)
  - [9. 实践案例](#9-实践案例)
  - [10. 最佳实践](#10-最佳实践)

## 1. 自动化运维概述

### 1.1 自动化运维目标

- **提高效率**: 减少人工操作，提高运维效率
- **降低错误**: 减少人为错误，提高系统稳定性
- **快速响应**: 快速响应故障和变更需求
- **标准化**: 建立标准化的运维流程

### 1.2 自动化运维架构

```text
┌─────────────────────────────────────────────────────────────┐
│                    自动化运维平台                            │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │   编排层     │  │   监控层     │  │   执行层     │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
└─────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────┐
│                    容器基础设施                              │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │   Kubernetes│  │   Docker    │  │   Podman    │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
└─────────────────────────────────────────────────────────────┘
```

## 2. 容器编排自动化

### 2.1 Kubernetes自动化

```yaml
# 自动部署配置
apiVersion: apps/v1
kind: Deployment
metadata:
  name: auto-deploy
spec:
  replicas: 3
  selector:
    matchLabels:
      app: auto-deploy
  template:
    metadata:
      labels:
        app: auto-deploy
    spec:
      containers:
      - name: app
        image: app:latest
        resources:
          requests:
            cpu: 100m
            memory: 256Mi
          limits:
            cpu: 500m
            memory: 512Mi
```

### 2.2 服务发现自动化

```yaml
# 服务自动发现
apiVersion: v1
kind: Service
metadata:
  name: auto-service
spec:
  selector:
    app: auto-deploy
  ports:
  - port: 80
    targetPort: 8080
  type: ClusterIP
```

## 3. 部署自动化

### 3.1 CI/CD流水线

```yaml
# GitLab CI配置
stages:
  - build
  - test
  - deploy

build:
  stage: build
  script:
    - docker build -t $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA .
    - docker push $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA

test:
  stage: test
  script:
    - docker run --rm $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA npm test

deploy:
  stage: deploy
  script:
    - kubectl set image deployment/app app=$CI_REGISTRY_IMAGE:$CI_COMMIT_SHA
    - kubectl rollout status deployment/app
```

### 3.2 蓝绿部署

```yaml
# 蓝绿部署配置
apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: blue-green-deploy
spec:
  replicas: 5
  strategy:
    blueGreen:
      activeService: blue-green-active
      previewService: blue-green-preview
      autoPromotionEnabled: false
      scaleDownDelaySeconds: 30
      prePromotionAnalysis:
        templates:
        - templateName: success-rate
        args:
        - name: service-name
          value: blue-green-preview
  selector:
    matchLabels:
      app: blue-green-deploy
  template:
    metadata:
      labels:
        app: blue-green-deploy
    spec:
      containers:
      - name: app
        image: app:latest
```

## 4. 监控自动化

### 4.1 自动告警

```yaml
# Prometheus告警规则
groups:
- name: container_alerts
  rules:
  - alert: HighCPUUsage
    expr: rate(container_cpu_usage_seconds_total[5m]) > 0.8
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "High CPU usage detected"
      description: "Container {{ $labels.name }} has high CPU usage"
```

### 4.2 自动恢复

```yaml
# 自动恢复配置
apiVersion: v1
kind: ConfigMap
metadata:
  name: auto-recovery
data:
  recovery.sh: |
    #!/bin/bash
    if ! curl -f http://localhost:8080/health; then
      kubectl rollout restart deployment/app
      sleep 30
      if curl -f http://localhost:8080/health; then
        echo "Service recovered successfully"
      else
        echo "Service recovery failed"
      fi
    fi
```

## 5. 故障自愈

### 5.1 健康检查

```yaml
# 健康检查配置
apiVersion: v1
kind: Pod
metadata:
  name: health-check-pod
spec:
  containers:
  - name: app
    image: app:latest
    livenessProbe:
      httpGet:
        path: /health
        port: 8080
      initialDelaySeconds: 30
      periodSeconds: 10
    readinessProbe:
      httpGet:
        path: /ready
        port: 8080
      initialDelaySeconds: 5
      periodSeconds: 5
```

### 5.2 自动重启

```yaml
# 自动重启配置
apiVersion: v1
kind: Pod
metadata:
  name: auto-restart-pod
spec:
  restartPolicy: Always
  containers:
  - name: app
    image: app:latest
    resources:
      limits:
        memory: "128Mi"
        cpu: "500m"
```

## 6. 扩缩容自动化

### 6.1 水平扩缩容

```yaml
# HPA配置
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: app-hpa
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: app
  minReplicas: 3
  maxReplicas: 10
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70
```

### 6.2 垂直扩缩容

```yaml
# VPA配置
apiVersion: autoscaling.k8s.io/v1
kind: VerticalPodAutoscaler
metadata:
  name: app-vpa
spec:
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: app
  updatePolicy:
    updateMode: "Auto"
```

## 7. 备份恢复自动化

### 7.1 自动备份

```yaml
# 备份CronJob
apiVersion: batch/v1
kind: CronJob
metadata:
  name: backup-job
spec:
  schedule: "0 2 * * *"
  jobTemplate:
    spec:
      template:
        spec:
          containers:
          - name: backup
            image: backup:latest
            command:
            - /bin/sh
            - -c
            - |
              kubectl get all -o yaml > backup-$(date +%Y%m%d).yaml
              kubectl get pv -o yaml >> backup-$(date +%Y%m%d).yaml
          restartPolicy: OnFailure
```

### 7.2 自动恢复

```yaml
# 恢复脚本
apiVersion: v1
kind: ConfigMap
metadata:
  name: restore-script
data:
  restore.sh: |
    #!/bin/bash
    BACKUP_FILE=$1
    if [ -f "$BACKUP_FILE" ]; then
      kubectl apply -f "$BACKUP_FILE"
      echo "Restore completed successfully"
    else
      echo "Backup file not found: $BACKUP_FILE"
    fi
```

## 8. 安全自动化

### 8.1 自动扫描

```yaml
# 安全扫描CronJob
apiVersion: batch/v1
kind: CronJob
metadata:
  name: security-scan
spec:
  schedule: "0 0 * * 0"
  jobTemplate:
    spec:
      template:
        spec:
          containers:
          - name: scanner
            image: trivy:latest
            command:
            - /bin/sh
            - -c
            - |
              trivy image --format json --output scan-results.json app:latest
              # 发送扫描结果到安全团队
          restartPolicy: OnFailure
```

### 8.2 自动更新

```yaml
# 自动更新配置
apiVersion: v1
kind: ConfigMap
metadata:
  name: auto-update
data:
  update.sh: |
    #!/bin/bash
    # 检查镜像更新
    NEW_IMAGE=$(kubectl get deployment app -o jsonpath='{.spec.template.spec.containers[0].image}')
    CURRENT_IMAGE=$(kubectl get deployment app -o jsonpath='{.status.conditions[?(@.type=="Progressing")].message}')
    
    if [ "$NEW_IMAGE" != "$CURRENT_IMAGE" ]; then
      kubectl set image deployment/app app=$NEW_IMAGE
      kubectl rollout status deployment/app
    fi
```

## 9. 实践案例

### 9.1 微服务自动化运维

```yaml
# 微服务自动化配置
apiVersion: v1
kind: ConfigMap
metadata:
  name: microservice-automation
data:
  automation.yaml: |
    services:
      - name: user-service
        image: user-service:latest
        replicas: 3
        resources:
          requests:
            cpu: 100m
            memory: 256Mi
          limits:
            cpu: 500m
            memory: 512Mi
        healthCheck:
          path: /health
          port: 8080
        autoScaling:
          minReplicas: 3
          maxReplicas: 10
          targetCPU: 70
```

### 9.2 数据库自动化运维

```yaml
# 数据库自动化配置
apiVersion: v1
kind: ConfigMap
metadata:
  name: database-automation
data:
  automation.yaml: |
    database:
      type: postgresql
      version: "13"
      replicas: 3
      backup:
        schedule: "0 2 * * *"
        retention: "30d"
      monitoring:
        enabled: true
        metrics: true
        logs: true
```

## 10. 最佳实践

### 10.1 自动化原则

1. **渐进式自动化**: 逐步实现自动化
2. **标准化流程**: 建立标准化流程
3. **监控和告警**: 完善的监控和告警
4. **文档和培训**: 完善的文档和培训

### 10.2 实施建议

1. **从简单开始**: 从简单的任务开始自动化
2. **逐步扩展**: 逐步扩展到复杂任务
3. **持续改进**: 持续改进自动化流程
4. **团队协作**: 加强团队协作和沟通

### 10.3 注意事项

1. **安全性**: 确保自动化过程的安全性
2. **可靠性**: 确保自动化过程的可靠性
3. **可维护性**: 确保自动化过程的可维护性
4. **可扩展性**: 确保自动化过程的可扩展性
