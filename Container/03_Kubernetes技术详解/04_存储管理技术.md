# 存储管理技术

## 目录

- [存储管理技术](#存储管理技术)
  - [目录](#目录)
  - [1. PV/PVC/StorageClass](#1-pvpvcstorageclass)
    - [1.1 存储基础概念](#11-存储基础概念)
      - [PersistentVolume (PV)](#persistentvolume-pv)
      - [PersistentVolumeClaim (PVC)](#persistentvolumeclaim-pvc)
      - [StorageClass](#storageclass)
    - [1.2 访问模式](#12-访问模式)
      - [访问模式类型](#访问模式类型)
      - [访问模式配置](#访问模式配置)
    - [1.3 绑定模式](#13-绑定模式)
      - [绑定模式类型](#绑定模式类型)
      - [绑定模式配置](#绑定模式配置)
  - [2. 动态供应与回收策略](#2-动态供应与回收策略)
  - [3. CSI 驱动与能力](#3-csi-驱动与能力)
  - [4. 数据保护：快照/备份/恢复](#4-数据保护快照备份恢复)
  - [5. 实践要点与 FAQ](#5-实践要点与-faq)
  - [6. 故障清单与排查](#6-故障清单与排查)
  - [7. 示例 YAML 与 SOP](#7-示例-yaml-与-sop)

## 1. PV/PVC/StorageClass

### 1.1 存储基础概念

#### PersistentVolume (PV)

- **定义**: 集群级别的存储资源
- **特点**: 由管理员创建，独立于Pod生命周期
- **配置示例**:

```yaml
apiVersion: v1
kind: PersistentVolume
metadata:
  name: pv-example
spec:
  capacity:
    storage: 10Gi
  accessModes:
  - ReadWriteOnce
  - ReadOnlyMany
  persistentVolumeReclaimPolicy: Retain
  storageClassName: fast-ssd
  hostPath:
    path: /data
```

#### PersistentVolumeClaim (PVC)

- **定义**: 用户对存储资源的请求
- **特点**: 绑定到特定PV，由用户创建
- **配置示例**:

```yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: pvc-example
  namespace: default
spec:
  accessModes:
  - ReadWriteOnce
  resources:
    requests:
      storage: 5Gi
  storageClassName: fast-ssd
```

#### StorageClass

- **定义**: 存储类的抽象
- **特点**: 定义存储提供者和参数
- **配置示例**:

```yaml
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: fast-ssd
provisioner: kubernetes.io/aws-ebs
parameters:
  type: gp3
  iops: "3000"
  throughput: "125"
  fsType: ext4
volumeBindingMode: WaitForFirstConsumer
allowVolumeExpansion: true
reclaimPolicy: Delete
```

### 1.2 访问模式

#### 访问模式类型

| 访问模式 | 描述 | 适用场景 |
|----------|------|----------|
| ReadWriteOnce | 单节点读写 | 数据库、单实例应用 |
| ReadOnlyMany | 多节点只读 | 配置文件、只读数据 |
| ReadWriteMany | 多节点读写 | 共享存储、文件系统 |
| ReadWriteOncePod | 单Pod读写 | 有状态应用 |

#### 访问模式配置

```yaml
apiVersion: v1
kind: PersistentVolume
metadata:
  name: pv-rwo
spec:
  capacity:
    storage: 10Gi
  accessModes:
  - ReadWriteOnce  # 单节点读写
  persistentVolumeReclaimPolicy: Retain
  storageClassName: standard
  awsElasticBlockStore:
    volumeID: vol-12345678
    fsType: ext4
```

### 1.3 绑定模式

#### 绑定模式类型

| 绑定模式 | 描述 | 适用场景 |
|----------|------|----------|
| Immediate | 立即绑定 | 静态PV |
| WaitForFirstConsumer | 等待首次消费者 | 动态PV，延迟绑定 |

#### 绑定模式配置

```yaml
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: delayed-binding
provisioner: kubernetes.io/aws-ebs
volumeBindingMode: WaitForFirstConsumer  # 延迟绑定
parameters:
  type: gp3
  iops: "3000"
  throughput: "125"
```

## 2. 动态供应与回收策略

- Retain/Delete/Recycle；扩容与缩容

## 3. CSI 驱动与能力

- 挂载、扩展、快照能力模型

## 4. 数据保护：快照/备份/恢复

- VolumeSnapshot CRDs、备份工具生态

## 5. 实践要点与 FAQ

- 常见问题与调试命令

（待补充：示例 YAML 与 SOP）

## 6. 故障清单与排查

- PVC Pending：检查 StorageClass、动态供应控制器与权限。
- 卷只读/不可挂载：核对访问模式、节点能力与驱动日志。
- 快照失败：确认 CRDs/控制器状态与底层存储能力映射。

## 7. 示例 YAML 与 SOP

```yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: data-pvc
spec:
  accessModes: ["ReadWriteOnce"]
  resources:
    requests:
      storage: 10Gi
  storageClassName: standard
```

SOP：

- 绑定状态：`kubectl get pvc data-pvc -o wide`
- 事件定位：`kubectl describe pvc data-pvc | sed -n '1,120p'`
- Pod 挂载失败时查看相关 Pod/Node/CSI 控制器日志。
