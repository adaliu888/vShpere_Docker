# Kubernetes服务发现与负载均衡深度解析

## 目录

- [Kubernetes服务发现与负载均衡深度解析](#kubernetes服务发现与负载均衡深度解析)
  - [目录](#目录)
  - [服务发现理论基础](#服务发现理论基础)
    - [服务发现数学模型](#服务发现数学模型)
    - [负载均衡算法理论](#负载均衡算法理论)
  - [负载均衡算法实现](#负载均衡算法实现)
    - [一致性哈希算法](#一致性哈希算法)
  - [Service模型深度分析](#service模型深度分析)
    - [ClusterIP Service](#clusterip-service)
      - [NodePort Service](#nodeport-service)
      - [LoadBalancer Service](#loadbalancer-service)
      - [Headless Service](#headless-service)
    - [1.2 会话亲和性](#12-会话亲和性)
      - [ClientIP会话亲和性](#clientip会话亲和性)
      - [负载均衡算法](#负载均衡算法)
  - [2. Ingress 与网关](#2-ingress-与网关)
    - [2.1 Ingress基础](#21-ingress基础)
      - [Ingress资源定义](#ingress资源定义)
      - [IngressClass配置](#ingressclass配置)
    - [2.2 主流Ingress控制器](#22-主流ingress控制器)
      - [NGINX Ingress Controller](#nginx-ingress-controller)
      - [Traefik Ingress Controller](#traefik-ingress-controller)
    - [2.3 Gateway API](#23-gateway-api)
      - [Gateway资源](#gateway资源)
      - [HTTPRoute资源](#httproute资源)
    - [2.4 高级Ingress功能](#24-高级ingress功能)
      - [路径重写](#路径重写)
      - [限流配置](#限流配置)
      - [认证配置](#认证配置)
  - [3. DNS 与服务发现](#3-dns-与服务发现)
  - [4. 外部流量与 LB](#4-外部流量与-lb)
  - [5. 实践要点与 FAQ](#5-实践要点与-faq)
  - [6. 故障清单与排查](#6-故障清单与排查)
  - [7. 示例 YAML 与 SOP](#7-示例-yaml-与-sop)

## 服务发现理论基础

### 服务发现数学模型

**定义1 (服务发现系统)**: 服务发现系统D是一个四元组

```text
D = (S, R, F, T)
```

其中：

- S = {s₁, s₂, ..., sₙ} 是服务集合请全面快速的 执行 多任务的执行
- R = {r₁, r₂, ..., rₘ} 是注册中心集合
- F: S → R 是服务到注册中心的映射函数
- T: S × S → ℝ⁺ 是服务间通信延迟函数

**定义2 (负载均衡器)**: 负载均衡器L是一个三元组

```text
L = (B, A, W)
```

其中：

- B = {b₁, b₂, ..., bₖ} 是后端服务实例集合
- A 是负载均衡算法
- W: B → ℝ⁺ 是权重函数

### 负载均衡算法理论

**算法1 (轮询算法)**:

```text
输入: 后端实例列表 B = {b₁, b₂, ..., bₙ}
输出: 选中的实例 bᵢ

1. current_index = 0
2. for each request do
3.   selected = B[current_index]
4.   current_index = (current_index + 1) mod n
5.   return selected
```

**算法2 (加权轮询算法)**:

```text
输入: 后端实例列表 B = {b₁, b₂, ..., bₙ}, 权重 W = {w₁, w₂, ..., wₙ}
输出: 选中的实例 bᵢ

1. total_weight = Σwᵢ
2. current_weight = 0
3. for each request do
4.   current_weight = (current_weight + 1) mod total_weight
5.   cumulative_weight = 0
6.   for i = 1 to n do
7.     cumulative_weight += wᵢ
8.     if current_weight <= cumulative_weight then
9.       return bᵢ
```

**算法3 (最少连接算法)**:

```text
输入: 后端实例列表 B = {b₁, b₂, ..., bₙ}
输出: 选中的实例 bᵢ

1. min_connections = ∞
2. selected_instance = null
3. for each bᵢ ∈ B do
4.   if connections(bᵢ) < min_connections then
5.     min_connections = connections(bᵢ)
6.     selected_instance = bᵢ
7. return selected_instance
```

## 负载均衡算法实现

### 一致性哈希算法

**定义3 (一致性哈希)**: 一致性哈希函数h满足：

1. 均匀性: 哈希值在哈希环上均匀分布
2. 单调性: 添加或删除节点时，只影响相邻节点
3. 平衡性: 负载在节点间均匀分布

**算法4 (一致性哈希)**:

```text
输入: 节点集合 N = {n₁, n₂, ..., nₙ}, 请求键 k
输出: 选中的节点 nᵢ

1. 计算哈希环: H = {h(n₁), h(n₂), ..., h(nₙ)}
2. 计算请求哈希: h(k)
3. 在H中找到第一个大于等于h(k)的哈希值
4. 返回对应的节点
```

## Service模型深度分析

### ClusterIP Service

- **用途**: 集群内部服务访问
- **特点**: 只能在集群内部访问，提供稳定的虚拟IP
- **配置示例**:

```yaml
apiVersion: v1
kind: Service
metadata:
  name: web-service
  namespace: default
spec:
  type: ClusterIP
  selector:
    app: web
  ports:
  - port: 80
    targetPort: 8080
    protocol: TCP
  sessionAffinity: ClientIP
  sessionAffinityConfig:
    clientIP:
      timeoutSeconds: 3600
```

#### NodePort Service

- **用途**: 通过节点端口暴露服务
- **特点**: 在每个节点上开放固定端口
- **配置示例**:

```yaml
apiVersion: v1
kind: Service
metadata:
  name: web-nodeport
spec:
  type: NodePort
  selector:
    app: web
  ports:
  - port: 80
    targetPort: 8080
    nodePort: 30080
    protocol: TCP
```

#### LoadBalancer Service

- **用途**: 云环境中的负载均衡器
- **特点**: 自动创建外部负载均衡器
- **配置示例**:

```yaml
apiVersion: v1
kind: Service
metadata:
  name: web-lb
  annotations:
    service.beta.kubernetes.io/aws-load-balancer-type: "nlb"
    service.beta.kubernetes.io/aws-load-balancer-backend-protocol: "tcp"
spec:
  type: LoadBalancer
  selector:
    app: web
  ports:
  - port: 80
    targetPort: 8080
    protocol: TCP
```

#### Headless Service

- **用途**: 无虚拟IP，直接返回Pod IP
- **特点**: 用于有状态服务或需要直接访问Pod的场景
- **配置示例**:

```yaml
apiVersion: v1
kind: Service
metadata:
  name: web-headless
spec:
  clusterIP: None
  selector:
    app: web
  ports:
  - port: 80
    targetPort: 8080
    protocol: TCP
```

### 1.2 会话亲和性

#### ClientIP会话亲和性

```yaml
apiVersion: v1
kind: Service
metadata:
  name: session-service
spec:
  type: ClusterIP
  selector:
    app: web
  ports:
  - port: 80
    targetPort: 8080
  sessionAffinity: ClientIP
  sessionAffinityConfig:
    clientIP:
      timeoutSeconds: 3600
```

#### 负载均衡算法

```yaml
apiVersion: v1
kind: Service
metadata:
  name: lb-service
  annotations:
    service.beta.kubernetes.io/aws-load-balancer-algorithm: "round_robin"
spec:
  type: LoadBalancer
  selector:
    app: web
  ports:
  - port: 80
    targetPort: 8080
```

## 2. Ingress 与网关

### 2.1 Ingress基础

#### Ingress资源定义

```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: web-ingress
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
spec:
  ingressClassName: nginx
  tls:
  - hosts:
    - web.example.com
    secretName: web-tls
  rules:
  - host: web.example.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: web-service
            port:
              number: 80
```

#### IngressClass配置

```yaml
apiVersion: networking.k8s.io/v1
kind: IngressClass
metadata:
  name: nginx
spec:
  controller: k8s.io/ingress-nginx
  parameters:
    apiGroup: k8s.io
    kind: IngressClassParameters
    name: nginx-config
```

### 2.2 主流Ingress控制器

#### NGINX Ingress Controller

```yaml
# 安装NGINX Ingress Controller
apiVersion: v1
kind: Namespace
metadata:
  name: ingress-nginx
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-ingress-controller
  namespace: ingress-nginx
spec:
  replicas: 2
  selector:
    matchLabels:
      app: nginx-ingress
  template:
    metadata:
      labels:
        app: nginx-ingress
    spec:
      containers:
      - name: nginx-ingress
        image: registry.k8s.io/ingress-nginx/controller:v1.8.1
        args:
        - /nginx-ingress-controller
        - --configmap=$(POD_NAMESPACE)/nginx-configuration
        - --tcp-services-configmap=$(POD_NAMESPACE)/tcp-services
        - --udp-services-configmap=$(POD_NAMESPACE)/udp-services
        - --publish-service=$(POD_NAMESPACE)/ingress-nginx
        - --annotations-prefix=nginx.ingress.kubernetes.io
```

#### Traefik Ingress Controller

```yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: traefik-ingress-controller
  namespace: kube-system
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: traefik-ingress-controller
  namespace: kube-system
spec:
  replicas: 2
  selector:
    matchLabels:
      app: traefik-ingress
  template:
    metadata:
      labels:
        app: traefik-ingress
    spec:
      serviceAccountName: traefik-ingress-controller
      containers:
      - name: traefik
        image: traefik:v2.10
        args:
        - --api.insecure=true
        - --providers.kubernetesingress=true
        - --entrypoints.web.address=:80
        - --entrypoints.websecure.address=:443
```

### 2.3 Gateway API

#### Gateway资源

```yaml
apiVersion: gateway.networking.k8s.io/v1beta1
kind: Gateway
metadata:
  name: web-gateway
  namespace: default
spec:
  gatewayClassName: nginx
  listeners:
  - name: http
    port: 80
    protocol: HTTP
    allowedRoutes:
      namespaces:
        from: All
  - name: https
    port: 443
    protocol: HTTPS
    tls:
      mode: Terminate
      certificateRefs:
      - name: web-tls
    allowedRoutes:
      namespaces:
        from: All
```

#### HTTPRoute资源

```yaml
apiVersion: gateway.networking.k8s.io/v1beta1
kind: HTTPRoute
metadata:
  name: web-route
  namespace: default
spec:
  parentRefs:
  - name: web-gateway
    namespace: default
  hostnames:
  - "web.example.com"
  rules:
  - matches:
    - path:
        type: PathPrefix
        value: /
    backendRefs:
    - name: web-service
      port: 80
```

### 2.4 高级Ingress功能

#### 路径重写

```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: rewrite-ingress
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /$2
spec:
  rules:
  - host: rewrite.example.com
    http:
      paths:
      - path: /api(/|$)(.*)
        pathType: Prefix
        backend:
          service:
            name: api-service
            port:
              number: 80
```

#### 限流配置

```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: rate-limit-ingress
  annotations:
    nginx.ingress.kubernetes.io/rate-limit: "100"
    nginx.ingress.kubernetes.io/rate-limit-window: "1m"
spec:
  rules:
  - host: api.example.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: api-service
            port:
              number: 80
```

#### 认证配置

```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: auth-ingress
  annotations:
    nginx.ingress.kubernetes.io/auth-type: basic
    nginx.ingress.kubernetes.io/auth-secret: basic-auth
    nginx.ingress.kubernetes.io/auth-realm: 'Authentication Required'
spec:
  rules:
  - host: secure.example.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: secure-service
            port:
              number: 80
```

## 3. DNS 与服务发现

- CoreDNS、Service/Endpoints、Headless + SRV

## 4. 外部流量与 LB

- 外部 LB 与云集成、MetalLB、本地直通

## 5. 实践要点与 FAQ

- 常见拓扑与排障清单

（待补充：示例 YAML 与流量策略）

## 6. 故障清单与排查

- Service 无法访问：确认选择器与 Endpoints；核对网络策略。
- NodePort 不通：检查节点防火墙、安全组与云路由。
- Ingress 404/证书问题：核对 IngressClass、TLS Secret 与主机名解析。

## 7. 示例 YAML 与 SOP

```yaml
apiVersion: v1
kind: Service
metadata:
  name: web-svc
spec:
  selector:
    app: web
  ports:
  - port: 80
    targetPort: 8080
    protocol: TCP
  type: ClusterIP
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: web-ing
  annotations:
    kubernetes.io/ingress.class: nginx
spec:
  tls:
  - hosts: ["web.example.com"]
    secretName: web-tls
  rules:
  - host: web.example.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: web-svc
            port:
              number: 80
```

SOP：

- 端点检查：`kubectl get endpoints web-svc -o wide`
- Ingress 路由：`kubectl describe ingress web-ing`
- 证书核对：`kubectl get secret web-tls -o yaml | head -n 40`
